# Live Origin. Unified Origin with a live publishing point.

ServerName live-origin

LoadModule smooth_streaming_module modules/mod_smooth_streaming.so

LogFormat {{LOG_FORMAT}} log_format

UspLicenseKey /etc/usp-license.key

<VirtualHost *:80>
  CustomLog /dev/stdout log_format
  ErrorLog /dev/stderr

  LogLevel {{LOG_LEVEL}} rewrite:{{LOG_LEVEL}}

  AddHandler smooth-streaming.extensions .isml

  DocumentRoot /var/www/live

  <Location />
    UspHandleIsm on
  </Location>

  Header set Access-Control-Allow-Headers "origin, range"
  Header set Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
  Header set Access-Control-Allow-Origin "*"
  Header set Access-Control-Expose-Headers "Server,range"

  RewriteEngine On
  # rewrite DASH Init '/test/test.isml/init-stream1.m4s' -> '/test/test.isml/Streams(stream1)'
  # rewrite DASH Chunk '/test/test.isml/chunk-stream1-00001.m4s' -> '/test.isml/Streams(stream1)'
  # rewrite DASH single_file '/test/test.isml/Streams(test-stream1.mp4' -> '/test/test.isml/Streams(stream1)'
  # rewrite HLS Init '/test/test.isml/init-stream1.m4s' -> '/test/test.isml/Streams(stream1)'
  # rewrite HLS Chunk '/test/test.isml/test-stream1.000.m4s' -> '/test/test.isml/Streams(stream1)'
  # rewrite HLS single_file '/test/test.isml/Streams(test-stream1.m4s' -> '/test/test.isml/Streams(stream1)'
  RewriteCond %{REQUEST_METHOD} ^(PUT|POST)
  RewriteRule "^(/test/.*\.isml)/(test-|init-|chunk-|Streams\(test-)(stream\d+).*\.(mp4|m4s)$" "$1/Streams($3)" [PT,L]
  # Redirect posing of Manifests and DELETE requests
  RewriteRule "^(/test/.*\.isml)/(Streams\(.*\.mpd\)|.*\.m3u8\))$" "/nothing" [R=204,L]
  RewriteCond %{REQUEST_METHOD} DELETE
  RewriteRule "^(/test/.*\.isml)/.*$" "/nothing" [R=204,L]

</VirtualHost>

<Directory /var/www/live>
    Require all granted
</Directory>
